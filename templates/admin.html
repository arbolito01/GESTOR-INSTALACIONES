{% extends "base.html" %}

{% block title %}Panel de Administrador{% endblock %}

{% block content %}
<div class="main-content-card">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">Panel de Administrador</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <ul class="flashes mb-4">
                {% for category, message in messages %}
                    <li class="alert alert-{{ category }}">{{ message }}</li>
                {% endfor %}
            </ul>
        {% endif %}
    {% endwith %}

    <h2 class="form-section-title mt-8 mb-4">Gestión de Solicitudes/Instalaciones</h2>
    <a href="{{ url_for('nueva_instalacion') }}" class="btn-primary mb-6">
        Añadir Nueva Instalación
    </a>
    <a href="{{ url_for('reparacion_migracion') }}" class="btn-primary mb-6">
        Reparación/Migración
    </a>

    <div class="overflow-x-auto mb-10">
        <table class="min-w-full bg-white rounded-lg shadow-md mt-4">
            <thead>
                <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                    <th class="py-3 px-6 text-left">ID</th>
                    <th class="py-3 px-6 text-left">Nombre</th>
                    <th class="py-3 px-6 text-left">Cliente</th>
                    <th class="py-3 px-6 text-left">Estado</th>
                    <th class="py-3 px-6 text-left">Técnico Asignado</th>
                    <th class="py-3 px-6 text-center">Acciones</th>
                </tr>
            </thead>
            <tbody class="text-gray-600 text-sm font-light">
                {% for instalacion in instalaciones %}
                <tr class="border-b border-gray-200 hover:bg-gray-100">
                    <td class="py-3 px-6 text-left whitespace-nowrap">{{ instalacion.id_instalacion }}</td>
                    <td class="py-3 px-6 text-left">{{ instalacion.nombre }}</td>
                    <td class="py-3 px-6 text-left">{{ instalacion.nombre_cliente }}</td>
                    <td class="py-3 px-6 text-left">
                        <span class="py-1 px-3 rounded-full text-xs font-semibold
                            {% if instalacion.estado == 'Completado' %}bg-green-200 text-green-600{% elif instalacion.estado == 'Asignado' %}bg-blue-200 text-blue-600{% else %}bg-yellow-200 text-yellow-600{% endif %}">
                            {{ instalacion.estado }}
                        </span>
                    </td>
                    <td class="py-3 px-6 text-left">
                        {% if instalacion.estado == 'Pendiente' %}
                            <form action="{{ url_for('asignar_tecnico_en_linea') }}" method="POST" class="inline-flex items-center gap-2">
                                <input type="hidden" name="id_instalacion" value="{{ instalacion.id_instalacion }}">
                                <select name="id_usuario_asignado" class="form-select text-sm p-1" required>
                                    <option value="">Seleccionar...</option>
                                    {% for tecnico in tecnicos %}
                                        <option value="{{ tecnico.id_usuario }}">{{ tecnico.nombre }}</option>
                                    {% endfor %}
                                </select>
                                <button type="submit" class="btn-sm btn-success">Guardar</button>
                            </form>
                        {% else %}
                            {{ instalacion.tecnico_asignado or 'No asignado' }}
                        {% endif %}
                    </td>
                    <td class="py-3 px-6 text-center whitespace-nowrap">
                        <a href="{{ url_for('editar_instalacion', id=instalacion.id_instalacion) }}" class="text-blue-500 hover:text-blue-700 mx-1">Editar</a>
                        <form action="{{ url_for('eliminar_instalacion', id=instalacion.id_instalacion) }}" method="POST" class="inline-block" onsubmit="return confirm('¿Estás seguro de que quieres eliminar esta instalación y todas sus reservas y tareas asociadas?');">
                            <button type="submit" class="text-red-500 hover:text-red-700 mx-1">Eliminar</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <h2 class="form-section-title mt-8 mb-4">Gestión de Usuarios</h2>
    <div class="overflow-x-auto">
        <table class="min-w-full bg-white rounded-lg shadow-md mt-4">
            <thead>
                <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                    <th class="py-3 px-6 text-left">ID</th>
                    <th class="py-3 px-6 text-left">Nombre</th>
                    <th class="py-3 px-6 text-left">Email</th>
                    <th class="py-3 px-6 text-left">Rol</th>
                    <th class="py-3 px-6 text-center">Acciones</th>
                </tr>
            </thead>
            <tbody class="text-gray-600 text-sm font-light">
                {% for usuario in usuarios %}
                <tr class="border-b border-gray-200 hover:bg-gray-100">
                    <td class="py-3 px-6 text-left whitespace-nowrap">{{ usuario.id_usuario }}</td>
                    <td class="py-3 px-6 text-left">{{ usuario.nombre }}</td>
                    <td class="py-3 px-6 text-left">{{ usuario.email }}</td>
                    <td class="py-3 px-6 text-left">
                        <span class="py-1 px-3 rounded-full text-xs font-semibold
                            {% if usuario.es_admin %}bg-red-200 text-red-600{% else %}bg-green-200 text-green-600{% endif %}">
                            {% if usuario.es_admin %}Admin{% else %}Instalador{% endif %}
                        </span>
                    </td>
                    <td class="py-3 px-6 text-center whitespace-nowrap">
                        <a href="{{ url_for('editar_usuario', id=usuario.id_usuario) }}" class="text-blue-500 hover:text-blue-700 mx-1">Editar</a>
                        <form action="{{ url_for('eliminar_usuario', id=usuario.id_usuario) }}" method="POST" class="inline-block" onsubmit="return confirm('¿Estás seguro de que quieres eliminar a este usuario?');">
                            <button type="submit" class="text-red-500 hover:text-red-700 mx-1">Eliminar</button>
                        </form>
                        <form action="{{ url_for('toggle_admin', id=usuario.id_usuario) }}" method="POST" class="inline-block">
                            {% if usuario.es_admin %}
                                <button type="submit" class="text-yellow-500 hover:text-yellow-700 mx-1">Degradar</button>
                            {% else %}
                                <button type="submit" class="text-green-500 hover:text-green-700 mx-1">Promover</button>
                            {% endif %}
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}