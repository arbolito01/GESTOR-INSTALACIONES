{% extends "base.html" %}

{% block title %}Completar Tarea{% endblock %}

{% block content %}
<div class="main-content-card">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">Completar Tarea: {{ tarea.nombre }}</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <ul class="flashes mb-4">
                {% for category, message in messages %}
                    <li class="alert alert-{{ category }}">{{ message }}</li>
                {% endfor %}
            </ul>
        {% endif %}
    {% endwith %}

    <form action="{{ url_for('completar_instalacion', instalacion_id=tarea.id_instalacion) }}" method="POST" enctype="multipart/form-data" class="space-y-4">
        <h2 class="form-section-title">Detalles de la Solicitud</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="form-group">
                <label class="form-label font-bold">Nombre del Cliente:</label>
                <p>{{ tarea.nombre_cliente }}</p>
            </div>
            <div class="form-group">
                <label class="form-label font-bold">Código de Cliente:</label>
                <p>{{ tarea.codigo_cliente }}</p>
            </div>
            <div class="form-group">
                <label class="form-label font-bold">Teléfono:</label>
                <p>{{ tarea.telefono_cliente }}</p>
            </div>
            <div class="form-group">
                <label class="form-label font-bold">Solicitud:</label>
                <p>{{ tarea.solicitud }}</p>
            </div>
            <div class="form-group">
                <label class="form-label font-bold">Referencia Domicilio:</label>
                <p>{{ tarea.referencia }}</p>
            </div>
            <div class="form-group">
                <label class="form-label font-bold">Ruta y Caja NAP:</label>
                <p>{{ tarea.ruta_caja_nap }}</p>
            </div>
        </div>

        <h2 class="form-section-title mt-6">Reporte de Finalización</h2>
        <div class="form-group">
            <label for="descripcion" class="form-label">Descripción del trabajo realizado:</label>
            <textarea id="descripcion" name="descripcion" class="form-textarea" required>{{ tarea.descripcion_final or '' }}</textarea>
        </div>

        <div class="form-group">
            <label for="foto" class="form-label">Foto de la instalación finalizada:</label>
            <input type="file" id="foto" name="foto" class="form-file" required>
        </div>

        <h2 class="form-section-title mt-6">Ubicación GPS (Obligatoria)</h2>
        <p class="text-sm text-gray-500 mb-2">Arrastra el marcador a la ubicación exacta o usa tu ubicación actual.</p>
        <button type="button" id="get-location-btn" class="btn-secondary w-full mb-4">Usar mi ubicación actual</button>
        <div id="map" class="h-64 w-full border border-gray-300 rounded-md mb-4"></div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="form-group">
                <label for="latitud" class="form-label">Latitud</label>
                <input type="text" id="latitud" name="latitud" class="form-input" placeholder="Ej: -12.046374" required readonly>
            </div>
            <div class="form-group">
                <label for="longitud" class="form-label">Longitud</label>
                <input type="text" id="longitud" name="longitud" class="form-input" placeholder="Ej: -77.042793" required readonly>
            </div>
        </div>

        <button type="submit" class="btn-primary w-full mt-6">
            Completar Tarea
        </button>
    </form>
</div>

<script>
    let map, marker;
    const latInput = document.getElementById('latitud');
    const lngInput = document.getElementById('longitud');
    const getLocationBtn = document.getElementById('get-location-btn');
    const initialLocation = "{{ tarea.ubicacion_gps or '0,0' }}".split(',').map(Number);
    const defaultLocation = { lat: initialLocation[0] || -12.046374, lng: initialLocation[1] || -77.042793 };

    function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            zoom: 12,
            center: defaultLocation,
        });

        marker = new google.maps.Marker({
            position: defaultLocation,
            map: map,
            draggable: true,
        });

        latInput.value = defaultLocation.lat;
        lngInput.value = defaultLocation.lng;

        marker.addListener("dragend", (event) => {
            const newLat = event.latLng.lat();
            const newLng = event.latLng.lng();
            latInput.value = newLat.toFixed(6);
            lngInput.value = newLng.toFixed(6);
        });

        getLocationBtn.addEventListener('click', () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                        };
                        map.setCenter(pos);
                        marker.setPosition(pos);
                        latInput.value = pos.lat.toFixed(6);
                        lngInput.value = pos.lng.toFixed(6);
                    },
                    () => {
                        handleLocationError(true, map.getCenter());
                    }
                );
            } else {
                handleLocationError(false, map.getCenter());
            }
        });
    }

    function handleLocationError(browserHasGeolocation, pos) {
        alert(
            browserHasGeolocation
                ? "Error: El servicio de geolocalización falló o no se concedieron los permisos."
                : "Error: Tu navegador no soporta geolocalización."
        );
    }
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCj9wq8Rhy7rOXccIQ8GbQN37Qd5GjfXvw&callback=initMap"></script>
{% endblock %}